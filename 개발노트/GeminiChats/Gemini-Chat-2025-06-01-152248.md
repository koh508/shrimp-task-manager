import undetected_chromedriver as uc
from selenium.webdriver.common.by import By
import time
import os
from datetime import datetime

# 저장 폴더 및 파일명 설정
SAVE_DIR = r"D:\백업폴더\OneDrive\Gemini Chat backup"
os.makedirs(SAVE_DIR, exist_ok=True)
timestamp = datetime.now().strftime("GeminiChat-%Y-%m-%d-%H%M%S.txt")
save_path = os.path.join(SAVE_DIR, timestamp)

# 크롬 프로필 경로 (로그인 세션 유지용, 필요시 수정)
USER_DATA_DIR = r'C:\Users\koko1\AppData\Local\Google\Chrome\User Data'
PROFILE_DIR = 'Default'  # 또는 'Profile 1' 등

options = uc.ChromeOptions()
options.add_argument(f'--user-data-dir={USER_DATA_DIR}')
options.add_argument(f'--profile-directory={PROFILE_DIR}')

print("undetected-chromedriver로 크롬 실행 중...")
driver = uc.Chrome(options=options)

try:
    print("Gemini 접속 중...")
    driver.get("https://gemini.google.com/app")
    input("로그인 및 원하는 대화창을 띄운 뒤 엔터를 누르세요...")

    while True:
        print("대화 내용 추출 시도 중...")
        time.sleep(5)
        chat_elements = driver.find_elements(By.CSS_SELECTOR, ".markdown, .ProseMirror, .message-content, .text-content")
        chats = [elem.text for elem in chat_elements if elem.text.strip()]
        print(f"추출된 메시지 개수: {len(chats)}")
        if chats:
            with open(save_path, "w", encoding="utf-8") as f:
                for chat in chats:
                    f.write(chat + "\n\n")
            print(f"[{datetime.now().strftime('%H:%M:%S')}] 대화 내용 자동 저장 완료: {save_path}")
        else:
            print("대화 내용을 찾지 못했습니다.")
        time.sleep(60)
except Exception as e:
    print("오류:", e)
finally:
    driver.quit()