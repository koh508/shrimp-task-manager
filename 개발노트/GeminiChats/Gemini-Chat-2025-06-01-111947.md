import time
import shutil
import os
from datetime import datetime
from threading import Event
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

SOURCE = r"D:\백업폴더\OneDrive NEW\Obsidian Vault"
DEST_BASE = r"D:\백업폴더\Obsidian_Backup"
IDLE_SECONDS = 600  # 10분 (원하는 시간으로 조절)

class ChangeHandler(FileSystemEventHandler):
    def __init__(self, wake_event):
        self.wake_event = wake_event

    def on_any_event(self, event):
        # 파일 변화가 감지되면 wake_event를 set해서 자동화 재개
        self.wake_event.set()

def backup():
    now = datetime.now().strftime("%Y%m%d_%H%M%S")
    dest = os.path.join(DEST_BASE, f"backup_{now}")
    try:
        shutil.copytree(SOURCE, dest)
        print(f"[{now}] 백업 완료: {dest}")
    except Exception as e:
        print(f"[{now}] 백업 실패: {e}")

def auto_backup_with_idle_pause():
    wake_event = Event()
    handler = ChangeHandler(wake_event)
    observer = Observer()
    observer.schedule(handler, path=SOURCE, recursive=True)
    observer.start()

    try:
        while True:
            # 변화가 있으면 바로 백업
            backup()
            # 변화가 없으면 대기
            print(f"[대기] {IDLE_SECONDS}초 동안 변화 없으면 멈춤. 변화 감지 시 재개.")
            wake_event.clear()
            is_wakeup = wake_event.wait(timeout=IDLE_SECONDS)
            if not is_wakeup:
                print(f"[일시정지] {IDLE_SECONDS}초 동안 변화 없음. 자동화 멈춤.")
                # 변화가 생길 때까지 무한 대기
                while not wake_event.wait(timeout=1):
                    pass
                print("[재개] 변화 감지됨. 자동화 재개.")
    finally:
        observer.stop()
        observer.join()

if __name__ == "__main__":
    auto_backup_with_idle_pause()