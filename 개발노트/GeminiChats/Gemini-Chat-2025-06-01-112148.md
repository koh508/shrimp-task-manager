import time
import shutil
import os
from datetime import datetime
from threading import Event
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

SOURCE = r"D:\백업폴더\OneDrive NEW\Obsidian Vault"
DEST_BASE = r"D:\백업폴더\Obsidian_Backup"
IDLE_SECONDS = 60  # 1분
LOG_PATH = r"D:\백업폴더\backup_log.txt"

class ChangeHandler(FileSystemEventHandler):
    def __init__(self, wake_event):
        self.wake_event = wake_event

    def on_any_event(self, event):
        self.wake_event.set()

def remove_blank_lines_from_log(log_path):
    if not os.path.exists(log_path):
        return
    with open(log_path, "r", encoding="utf-8") as f:
        lines = f.readlines()
    lines = [line for line in lines if line.strip()]
    with open(log_path, "w", encoding="utf-8") as f:
        f.writelines(lines)

def backup():
    now = datetime.now().strftime("%Y%m%d_%H%M%S")
    dest = os.path.join(DEST_BASE, f"backup_{now}")
    try:
        shutil.copytree(SOURCE, dest)
        log_msg = f"[{now}] 백업 완료: {dest}\n"
    except Exception as e:
        log_msg = f"[{now}] 백업 실패: {e}\n"
    with open(LOG_PATH, "a", encoding="utf-8") as f:
        f.write(log_msg)
    remove_blank_lines_from_log(LOG_PATH)
    # 콘솔에도 공백 로그는 출력하지 않음
    if log_msg.strip():
        print(log_msg, end="")

def auto_backup_with_idle_pause():
    wake_event = Event()
    handler = ChangeHandler(wake_event)
    observer = Observer()
    observer.schedule(handler, path=SOURCE, recursive=True)
    observer.start()

    try:
        while True:
            backup()
            print(f"[대기] {IDLE_SECONDS}초 동안 변화 없으면 멈춤. 변화 감지 시 재개.")
            wake_event.clear()
            is_wakeup = wake_event.wait(timeout=IDLE_SECONDS)
            if not is_wakeup:
                print(f"[일시정지] {IDLE_SECONDS}초 동안 변화 없음. 자동화 멈춤.")
                while not wake_event.wait(timeout=1):
                    pass
                print("[재개] 변화 감지됨. 자동화 재개.")
    finally:
        observer.stop()
        observer.join()

if __name__ == "__main__":
    auto_backup_with_idle_pause()